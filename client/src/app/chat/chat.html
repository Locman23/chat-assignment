<section class="chat-layout">
  <!-- Sidebar: groups and channels -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h3>Groups</h3>
    </div>

    <div class="group-list" *ngIf="visibleGroups().length; else noGroups">
      <div class="group-item" *ngFor="let g of visibleGroups()">
        <button class="group-btn" [class.active]="g.id === selectedGroupId" (click)="selectGroup(g.id)">
          <span class="group-name">{{ g.name }}</span>
        </button>
        <!-- Channels only visible if member (super sees all groups but we still require membership to view channels) -->
        <ul class="channel-list" *ngIf="isMember(g)">
          <li *ngFor="let c of (g.channels || [])">
            <button class="channel-btn" [class.active]="c.id === selectedChannelId && g.id === selectedGroupId" (click)="selectChannelOfGroup(g.id, c.id)">
              # {{ c.name }}
            </button>
          </li>
        </ul>
      </div>
    </div>
    <ng-template #noGroups>
      <div class="muted small">No groups available or you are not a member of any group.</div>
    </ng-template>
  </aside>

  <!-- Main chat area -->
  <main class="chat">
    <div class="chat-header">
      <h2 *ngIf="selectedGroup as sg; else chooseGroup">
        {{ sg.name }}
        <span class="muted" *ngIf="selectedChannel as sc">/ #{{ sc?.name }}</span>
      </h2>
      <ng-template #chooseGroup><h2>Select a group</h2></ng-template>
      <div class="muted small" *ngIf="statusMsg">{{ statusMsg }}</div>
      <div class="msg msg-error" *ngIf="errorMsg">{{ errorMsg }}</div>
      <div class="presence" *ngIf="presenceUsers.length && selectedChannelId">
        <span class="presence-label">Online:</span>
        <span class="presence-user" *ngFor="let u of presenceUsers; let last = last">{{ u }}<span *ngIf="!last">, </span></span>
      </div>
    </div>

  <div class="chat-body" #scrollContainer (scroll)="onScroll()">
      <div *ngIf="!selectedGroupId || !selectedChannelId" class="msg msg-muted">
        Pick a channel to start chatting. Messages will appear here.
      </div>

      <ul *ngIf="selectedGroupId && selectedChannelId" class="message-list">
        <li *ngFor="let m of messages" class="message" [class.system]="m.username === 'system'">
          <ng-container *ngIf="m.username !== 'system'; else systemMsg">
            <span class="author">{{ m.username }}</span>
            <span class="text">{{ m.text }}</span>
            <span class="time">{{ m.ts | date:'shortTime' }}</span>
          </ng-container>
          <ng-template #systemMsg>
            <span class="system-text">{{ m.text }} <span class="time">{{ m.ts | date:'shortTime' }}</span></span>
          </ng-template>
        </li>
      </ul>
      <div class="typing-indicator" *ngIf="typingDisplay() as td">{{ td }}</div>
    </div>

    <form class="chat-input" (ngSubmit)="onSend()" *ngIf="selectedGroupId && selectedChannelId; else noChannelSelected">
      <input class="input" type="text" placeholder="Message" [(ngModel)]="messageText" name="message" [disabled]="!selectedGroupId || !selectedChannelId" (input)="onInputChange()" />
      <button class="btn" type="submit" [disabled]="!messageText">Send</button>
    </form>
    <ng-template #noChannelSelected>
      <div class="chat-input muted" style="justify-content:center; font-size:13px;">Select a group & channel to start chatting.</div>
    </ng-template>
  </main>

  <!-- Roster column -->
  <aside class="roster" *ngIf="selectedGroupId">
    <div class="roster-header">
      <h3>Users</h3>
    </div>
    <ul class="roster-list">
      <li *ngFor="let u of roster" class="roster-item" [class.active]="u.status==='active'" [class.online]="u.status==='online'" [class.offline]="u.status==='offline'">
        <span class="status-dot" [attr.data-status]="u.status"></span>
        <span class="name">{{ u.username }}</span>
      </li>
    </ul>
    <div class="roster-legend">
      <div><span class="status-dot legend active"></span> Active here</div>
      <div><span class="status-dot legend online"></span> Online elsewhere</div>
      <div><span class="status-dot legend offline"></span> Offline</div>
    </div>
  </aside>
</section>
