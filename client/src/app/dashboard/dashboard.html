<section class="dashboard-header">
  <h2>Dashboard</h2>
  <p *ngIf="isSuper()" class="muted">You are a Super Admin.</p>
</section>

<!-- Users (Super Admin only) -->
  <section *ngIf="isSuper()" class="panel panel-wide">
    <h3>Users</h3>
    <form (ngSubmit)="addUser()" #userForm="ngForm" class="form-inline">
      <input id="username" class="input" name="username" [(ngModel)]="newUser.username" required placeholder="username" />
      <input id="email" class="input" name="email" [(ngModel)]="newUser.email" required placeholder="email" />
      <input id="password" class="input" name="password" [(ngModel)]="newUser.password" type="password" required placeholder="password" />
      <button type="submit" class="btn" [disabled]="userForm.invalid">Add User</button>
    </form>
    <div *ngIf="addUserError" class="msg msg-error">{{ addUserError }}</div>
    <div *ngIf="addUserSuccess" class="msg msg-success">User added!</div>

    <input class="input fullwidth" type="text" [(ngModel)]="userSearch" placeholder="Search users..." />

    <table class="table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of (users | userFilter:userSearch)" [hidden]="user.username === 'super'">
          <td>{{ user.username }}</td>
          <td>{{ user.email }}</td>
          <td>
            <select [(ngModel)]="user.roles[0]" (change)="changeUserRole(user)" class="input" [disabled]="user.roles[0] === 'Super Admin'">
              <option *ngIf="user.roles[0] === 'Super Admin'" value="Super Admin">Super Admin</option>
              <option *ngIf="user.roles[0] !== 'Super Admin'" value="Group Admin">Group Admin</option>
              <option *ngIf="user.roles[0] !== 'Super Admin'" value="User">User</option>
            </select>
          </td>
          <td>
            <button class="btn btn-sm mr-2" (click)="editUser(user)">Edit</button>
            <button class="btn btn-sm btn-danger" (click)="deleteUser(user)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
    <div *ngIf="userActionError" class="msg msg-error">{{ userActionError }}</div>
    <div *ngIf="userActionSuccess" class="msg msg-success">{{ userActionSuccess }}</div>
  </section>

  <!-- Groups (visible to authenticated users) -->
  <section class="panel panel-wide">
    <h3>Groups</h3>
  <form *ngIf="canCreateGroup()" (ngSubmit)="addGroup()" #groupForm="ngForm" class="form-inline">
      <input id="groupName" class="input" name="name" [(ngModel)]="newGroup.name" required placeholder="Group name" />
      <button class="btn" type="submit" [disabled]="groupForm.invalid">Add Group</button>
    </form>
    <div *ngIf="addGroupError" class="msg msg-error">{{ addGroupError }}</div>
    <div *ngIf="addGroupSuccess" class="msg msg-success">Group added!</div>

    <input class="input fullwidth" type="text" [(ngModel)]="groupSearch" placeholder="Search groups..." />

    <table class="table">
      <thead>
        <tr>
          <th>Group Name</th>
          <th>Owner</th>
          <th>Members</th>
          <th>Channels</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let group of (groups | groupFilter:groupSearch)">
          <td>{{ group.name }}</td>
          <td>{{ group.ownerUsername }}</td>
          <td>
            <ul class="compact-list">
              <li *ngFor="let member of (group.displayMembers || [])">
                {{ member }}
                <button *ngIf="canAdminGroup(group) && member !== group.ownerUsername" class="btn btn-sm mr-2" (click)="removeMemberFromGroup(group, member)">Remove</button>
                <button *ngIf="(isSuper() || isGroupOwner(group)) && member !== group.ownerUsername" class="btn btn-sm" (click)="toggleGroupAdmin(group, member)" [attr.aria-label]="isGroupAdmin(group, member) ? 'Remove admin ' + member : 'Make admin ' + member">{{ isGroupAdmin(group, member) ? 'Remove Admin' : 'Make Admin' }}</button>
              </li>
            </ul>
            <form *ngIf="canAdminGroup(group)" (ngSubmit)="addMemberToGroup(group)" #addMemberForm="ngForm" class="form-inline mt-2">
              <input class="input small-w" name="username" [(ngModel)]="group.newMember" placeholder="Add member..." required />
              <button class="btn btn-sm" type="submit" [disabled]="addMemberForm.invalid">Add</button>
            </form>
            <!-- Request to join if not a member -->
            <div *ngIf="!isSuper() && !isMember(group)" class="mt-2">
              <button class="btn btn-sm" (click)="requestToJoin(group)" aria-label="Request to join {{ group.name }}">Request to join</button>
            </div>
          </td>
          <td>
            <ul class="compact-list">
              <li *ngFor="let channel of group.channels">{{ channel.name }}</li>
            </ul>
            <form *ngIf="canAdminGroup(group)" (ngSubmit)="addChannelToGroup(group)" #addChannelForm="ngForm" class="form-inline mt-2">
              <input class="input small-w" name="name" [(ngModel)]="group.newChannel" placeholder="Add channel..." required />
              <button class="btn btn-sm" type="submit" [disabled]="addChannelForm.invalid">Add</button>
            </form>
          </td>
          <td>
            <button *ngIf="canAdminGroup(group)" class="btn btn-sm mr-2" (click)="editGroup(group)">Edit</button>
            <button *ngIf="canAdminGroup(group)" class="btn btn-sm btn-danger" (click)="deleteGroup(group)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
    <div *ngIf="groupActionError" class="msg msg-error">{{ groupActionError }}</div>
    <div *ngIf="groupActionSuccess" class="msg msg-success">{{ groupActionSuccess }}</div>
  </section>

  <!-- Super Admin: pending join requests -->
  <section *ngIf="isSuper()" class="panel panel-wide mt-4">
    <h3>Pending Join Requests</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Request ID</th>
          <th>User</th>
          <th>Group</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of joinRequests">
          <td>{{ r.id }}</td>
          <td>{{ r.username }}</td>
          <td>{{ getGroupNameById(r.gid) }}</td>
          <td>{{ r.createdAt | date:'short' }}</td>
          <td>
            <button class="btn btn-sm mr-2" (click)="approveRequest(r)">Approve</button>
            <button class="btn btn-sm btn-danger" (click)="denyRequest(r)">Deny</button>
          </td>
        </tr>
      </tbody>
    </table>
  </section>
<!-- end dashboard -->

